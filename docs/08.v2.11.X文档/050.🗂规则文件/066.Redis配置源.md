---
title: 📑Redis配置源
date: 2023-08-23 19:55:26
permalink: /pages/186747/
---

LiteFlow从v2.11.0开始，原生支持了Redis的规则配置源。

## 依赖

如果使用Redis作为规则配置源，你需要添加以下额外插件依赖：

```xml
<dependency>
    <groupId>com.yomahub</groupId>
    <artifactId>liteflow-rule-redis</artifactId>
    <version>2.11.0</version>
</dependency>
```

## 配置模式

Redis配置源支持平滑热刷新，在刷新机制上实现了【**轮询**】和【**订阅**】两种模式，可依据需要选择。

>【**轮询模式**】：基于Redis的Hash结构，通过定时轮询的方式进行规则刷新，轮询频率可配置，轮询间隔内有一定刷新延迟。
>
>【**订阅模式**】：依赖于Redisson客户端的RMapCache存储结构，只支持将规则数据存储在独有的RMapCache结构中；可实现规则的实时平滑刷新。

两种模式的插件依赖相同，仅通过配置参数加以区分。

如果没有配置mode参数，默认选择为轮询模式。



## 配置

依赖了插件包之后，你无需再配置`liteflow.ruleSource`路径。

只需要配置插件的额外参数即可。

Redis配置源支持单点和哨兵模式，在轮询和订阅两种机制下配置分别如下：


### 轮询模式

<code-group>
  <code-block title="Yaml风格配置" active>

```yaml
liteflow:
  rule-source-ext-data-map:
    #单点模式配置如下两项
    host: 127.0.0.1
    port: 6379
    #哨兵模式配置如下三项
    redisMode: sentinel
    masterName: mymaster
    sentinelAddress: [127.0.0.1:26389, 127.0.0.1:26379]
    #如果你没有用户名或密码可以不配置
    username: root
    password: 123456
    mode: poll
    pollingInterval: 60
    pollingStartTime: 60
    chainDataBase: 1
    chainKey: chainKey
    #如果你没有脚本组件，以下可以不配置
    scriptDataBase: 1
    scriptKey: scriptKey
```

  </code-block>
  <code-block title="Properties风格配置">

```properties
liteflow.rule-source-ext-data={\
      \# 单点模式配置如下两项\
      "host":"localhost",\
      "port":6379,\
      \# 哨兵模式配置如下三项\
      "redisMode":"sentinel",\
      "masterName":"mymaster",\
      "sentinelAddress":["127.0.0.1:26389","127.0.0.1:26379"],\
      "username":"root",\
      "password":"123456",\
      "mode":"poll",\
      "pollingInterval":60,\
      "pollingStartTime":60,\
      "chainDataBase":1,\
      "chainKey":"chainKey",\
      "scriptDataBase":1,\
      "scriptKey":"scriptKey"\
}
```
  </code-block>

</code-group>



### 订阅模式

<code-group>
  <code-block title="Yaml风格配置" active>

```yaml
liteflow:
  rule-source-ext-data-map:
    #单点模式配置如下两项
    host: 127.0.0.1
    port: 6379
    #哨兵模式配置如下三项
    redisMode: sentinel
    masterName: mymaster
    sentinelAddress: [127.0.0.1:26389, 127.0.0.1:26379]
    #如果你没有用户名或密码可以不配置
    username: root
    password: 123456
    mode: sub
    chainDataBase: 1
    chainKey: chainKey
    #如果你没有脚本组件，以下可以不配置
    scriptDataBase: 1
    scriptKey: scriptKey
```

  </code-block>
  <code-block title="Properties风格配置">

```properties
liteflow.rule-source-ext-data={\
      \# 单点模式配置如下两项\
      "host":"localhost",\
      "port":6379,\
      \# 哨兵模式配置如下三项\
      "redisMode":"sentinel",\
      "masterName":"mymaster",\
      "sentinelAddress":["127.0.0.1:26389","127.0.0.1:26379"],\
      "username":"root",\
      "password":"123456",\
      "mode":"sub",\
      "chainDataBase":1,\
      "chainKey":"chainKey",\
      "scriptDataBase":1,\
      "scriptKey":"scriptKey"\
}
```
  </code-block>

</code-group>


## 配置说明

| 配置项             | 说明                                    |
|-----------------|---------------------------------------|
| redisMode       | Redis模式，single为单点，sentinel为哨兵，默认为单点   |
| host            | 单点模式Redis连接IP地址                       |
| port            | 单点模式Redis连接端口号                        |
| masterName      | 哨兵模式主节点名                              |
| sentinelAddress | 哨兵模式哨兵节点连接地址 ip:port                  |
| username        | Redis的用户名 (Redis 6.0及以上)              |
| password        | Redis的密码                              |
| mode      | 规则刷新模式，poll为轮询，sub/subscribe为订阅，默认为轮询 |
| chainDataBase        | 规则数据的数据库号                             |
| chainKey     | 规则数据的Redis key名                       |
| scriptDataBase | 脚本组件的数据库号                             |
| scriptKey        | 脚本组件的Redis key名                       |
| pollingInterval | 轮询时间间隔(s)，默认为60s                      |
| pollingStartTime        | 规则配置后首次轮询的起始时间(s)，默认为60s              |


## 存储数据说明

### 轮询模式

:::tip

在轮询模式中，规则和脚本数据均以Redis hash结构存储，配置项`chainKey`和`scriptKey`即为该hash的名字。

:::

对于规则来说，你在Redis中需要为规则单独创建一个Hash类型的数据，这个hash内的每个键值对就是一个规则，**hash内的field为chainId，value为单纯的EL（`THEN(a,b,c)`）**。

假设你的规则hash数据键名为:`chains`，那么配置形式样例如下：


| Redis HashKey：chains |                              |
|----------------------| ---------------------------- |
| chain1               | THEN(a, b, c);               |
| chain2               | IF(x, b).ELIF(y, c).ELSE(d); |

对于脚本来说，hash中的field有固定格式：`脚本组件ID:脚本类型:脚本名称[:脚本语言]`，value为脚本数据。

假设你的脚本hash数据键名为：`scripts`，那么配置形式样例如下：

| Redis HashKey：scripts |                                              |
|-----------------------|----------------------------------------------|
| s1:script:脚本组件1       | defaultContext.setData("s1","hello")         |
| s2:script:脚本组件2:js    | defaultContext.setData("s2","hello")         |
| s3:if_script:脚本组件3    | if(a > 100){return true;}else{return false;} |

关于脚本类型，可以参照[定义脚本组件](/pages/81d53c/)这一章节。

<br>

### 订阅模式

:::tip

在订阅模式中，规则和脚本数据均以Redisson RMapCache结构存储，配置项`chainKey`和`scriptKey`即为该RMapCache的名字。

:::

对于规则来说，你需要使用Redisson客户端，为规则单独创建一个RMapCache类型的数据，这个结构内的每个键值对就是一个规则，**RMapCache内的key为chainId，value为单纯的EL（`THEN(a,b,c)`）**。

假设你的规则RMapCache数据键名为:`chains`，那么利用Redisson客户端的数据操作如下：


```java
RMapCache<String, String> chainKey = redissonClient.getMapCache("chains");
chains.put("chain1", "THEN(a, b, c);");
chains.put("chain2", "IF(x, b).ELIF(y, c).ELSE(d);");
```

对于脚本来说，RMapCache中的key有固定格式：`脚本组件ID:脚本类型:脚本名称[:脚本语言]`，value为脚本数据。

假设你的脚本RMapCache数据键名为:`scripts`，那么利用Redisson客户端的数据操作如下：

```java
RMapCache<String, String> scriptKey = redissonClient.getMapCache("scripts");
scripts.put("s1:script:脚本组件1", "defaultContext.setData(\"test1\",\"hello\");");
scripts.put("s2:script:脚本组件2:js", "defaultContext.setData(\"test2\",\"hello\");");
```

关于脚本类型，可以参照[定义脚本组件](/pages/81d53c/)这一章节。


## 自动刷新

使用了此Redis配置源插件，凡是在配置的Redis键内的数据改动，会自动推送到业务系统（轮询模式会依据设定的轮询参数定期推送），你无需做任何事情。


## 小例子

为了让大家能简单上手Redis规则文件的配置和运行，这里有一个小demo，大家可以拉到本地来运行，需要你替换Redis的配置信息。

运行项目前，先读项目里的`readme.txt`文件。

> https://github.com/bryan31/liteflow-ext-rule-demo